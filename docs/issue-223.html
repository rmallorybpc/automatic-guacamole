<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Issues Dashboard (Meta Issue #223)</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.35; }
      header { display: flex; align-items: baseline; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
      h1 { margin: 0; font-size: 22px; }
      .meta { color: #555; font-size: 13px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin: 16px 0 20px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
      .kpi { font-size: 28px; font-weight: 650; margin-top: 6px; }
      h2 { margin: 22px 0 10px; font-size: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; vertical-align: top; }
      th { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: .02em; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
      .error { color: #b00020; }
      a { color: #0969da; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Issues Dashboard (Meta Issue #223)</h1>
        <div class="meta">
          Loads: <code>reports/dashboard_issue_223.json</code>
        </div>
      </div>
      <div class="meta" id="generatedAt"></div>
    </header>

    <section class="grid">
      <div class="card">
        <div class="meta">Total features</div>
        <div class="kpi" id="totalFeatures">—</div>
      </div>
      <div class="card">
        <div class="meta">First discovered</div>
        <div class="kpi" id="firstDate">—</div>
      </div>
      <div class="card">
        <div class="meta">Last discovered</div>
        <div class="kpi" id="lastDate">—</div>
      </div>
    </section>

    <h2>Time series</h2>
    <div class="card">
      <table id="timeSeriesTable">
        <thead><tr><th>Date</th><th>Count</th><th>Cumulative</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Source breakdown</h2>
    <div class="card">
      <table id="sourceTable">
        <thead><tr><th>Source</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Product area breakdown</h2>
    <div class="card">
      <table id="productAreaTable">
        <thead><tr><th>Category</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Features</h2>
    <div class="card">
      <table id="featuresTable">
        <thead><tr><th>Date</th><th>Title</th><th>Category</th><th>Source</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Raw JSON</h2>
    <pre id="rawJson">Loading…</pre>

    <script>
      const DATA_URL = 'reports/dashboard_issue_223.json';

      function text(el, value) { el.textContent = value; }

      function clearTbody(table) {
        const tbody = table.querySelector('tbody');
        while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
        return tbody;
      }

      function row(tbody, cells) {
        const tr = document.createElement('tr');
        for (const c of cells) {
          const td = document.createElement('td');
          if (c instanceof Node) td.appendChild(c);
          else td.textContent = String(c);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function link(href, label) {
        const a = document.createElement('a');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
      }

      function yyyyMmDd(iso) {
        if (!iso) return '';
        return String(iso).slice(0, 10);
      }

      async function load() {
        try {
          const resp = await fetch(DATA_URL, { cache: 'no-store' });
          if (!resp.ok) throw new Error(`Failed to load ${DATA_URL}: ${resp.status}`);
          const data = await resp.json();

          text(document.getElementById('generatedAt'), `generated_at: ${data.generated_at || '—'}`);
          text(document.getElementById('totalFeatures'), data?.summary?.total_features ?? '—');

          const features = Array.isArray(data.features) ? data.features : [];
          const dates = features.map(f => yyyyMmDd(f.date_discovered)).filter(Boolean).sort();
          text(document.getElementById('firstDate'), dates[0] || '—');
          text(document.getElementById('lastDate'), dates[dates.length - 1] || '—');

          // Time series
          {
            const tbody = clearTbody(document.getElementById('timeSeriesTable'));
            const ts = data?.time_series?.time_series || [];
            for (const r of ts) row(tbody, [r.date, r.count, r.cumulative]);
          }

          // Source breakdown
          {
            const tbody = clearTbody(document.getElementById('sourceTable'));
            const rows = data?.source_breakdown?.sources || [];
            for (const r of rows) row(tbody, [r.name, r.count]);
          }

          // Product areas
          {
            const tbody = clearTbody(document.getElementById('productAreaTable'));
            const rows = data?.product_area_breakdown?.product_areas || [];
            for (const r of rows) row(tbody, [r.name, r.count]);
          }

          // Features
          {
            const tbody = clearTbody(document.getElementById('featuresTable'));
            for (const f of features) {
              row(tbody, [
                yyyyMmDd(f.date_discovered),
                link(f.source_url, f.title || f.id),
                f.product_area || '',
                f.source_type || '',
              ]);
            }
          }

          text(document.getElementById('rawJson'), JSON.stringify(data, null, 2));

        } catch (err) {
          const pre = document.getElementById('rawJson');
          pre.classList.add('error');
          pre.textContent = String(err);
        }
      }

      load();
    </script>
  </body>
</html>
