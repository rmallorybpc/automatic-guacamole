<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Issues Dashboard</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.35; }
      header { display: flex; align-items: baseline; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
      h1 { margin: 0; font-size: 22px; }
      .meta { color: #555; font-size: 12px; }
      .toplinks { margin-top: 6px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin: 12px 0 16px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
      .kpiCard { padding: 8px; }
      .kpi { font-size: 16px; font-weight: 650; margin-top: 4px; }
      h2 { margin: 22px 0 10px; font-size: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; vertical-align: top; }
      th { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: .02em; }
      hr { border: 0; border-top: 1px solid #eee; margin: 6px 0; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
      .error { color: #b00020; }
      a { color: #0969da; text-decoration: none; }
      a:hover { text-decoration: underline; }
      details > summary { cursor: pointer; user-select: none; }
      .sectionHeader { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
      .legend { color: #555; font-size: 13px; white-space: nowrap; }
      .legendItem { display: inline-flex; align-items: baseline; gap: 6px; margin-left: 10px; }
      .issueRow { display: flex; align-items: baseline; gap: 8px; margin: 2px 0; }
      .statusIcon { width: 14px; flex: 0 0 14px; text-align: center; font-size: 12px; line-height: 1; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Issues Dashboard</h1>
      </div>
      <div class="meta" id="generatedAt"></div>
    </header>

    <section class="grid">
      <div class="card kpiCard">
        <div class="meta">Total features</div>
        <div class="kpi" id="totalFeatures">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">First discovered</div>
        <div class="kpi" id="firstDate">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Last discovered</div>
        <div class="kpi" id="lastDate">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Opened (last 7 days)</div>
        <div class="kpi" id="openedLast7">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Closed (last 7 days)</div>
        <div class="kpi" id="closedLast7">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Opened (last 30 days)</div>
        <div class="kpi" id="openedLast30">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Closed (last 30 days)</div>
        <div class="kpi" id="closedLast30">—</div>
      </div>
    </section>

    <div class="sectionHeader">
      <h2>Product area breakdown</h2>
      <div class="legend" aria-label="Status legend">
        <span class="legendItem"><span class="statusIcon" aria-label="open">◯</span><span>open</span></span>
        <span class="legendItem"><span class="statusIcon" aria-label="closed">✓</span><span>closed</span></span>
        <span class="legendItem">Closed issues &gt;30 days hidden</span>
      </div>
    </div>
    <div class="card">
      <table id="productAreaTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Time series</h2>
    <details class="card" id="timeSeriesDetails">
      <summary class="meta">Expand / collapse</summary>
      <table id="timeSeriesTable">
        <thead><tr><th>Date</th><th>Count</th><th>Cumulative</th></tr></thead>
        <tbody></tbody>
      </table>
    </details>

    <h2>Raw JSON</h2>
    <div class="meta">Loads: <code>reports/dashboard_issue_223.json</code></div>
    <details class="card" id="rawJsonDetails">
      <summary class="meta">Expand / collapse</summary>
      <pre id="rawJson">Loading…</pre>
    </details>

    <script>
      const DATA_URL = 'reports/dashboard_all_issues.json';

      function text(el, value) { el.textContent = value; }
      function yyyyMmDd(iso) { return iso ? String(iso).slice(0, 10) : ''; }

      function msSinceEpoch(iso) {
        if (!iso) return null;
        const d = new Date(String(iso));
        const t = d.getTime();
        return Number.isFinite(t) ? t : null;
      }

      function countSinceMs(items, getIso, thresholdMs) {
        let n = 0;
        for (const it of items) {
          const t = msSinceEpoch(getIso(it));
          if (t != null && t >= thresholdMs) n += 1;
        }
        return n;
      }

      function clearTbody(table) {
        const tbody = table.querySelector('tbody');
        while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
        return tbody;
      }

      function row(tbody, cells) {
        const tr = document.createElement('tr');
        for (const c of cells) {
          const td = document.createElement('td');
          if (c instanceof Node) td.appendChild(c);
          else td.textContent = String(c);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function link(href, label) {
        const a = document.createElement('a');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
      }

      function statusIcon(state) {
        const s = String(state || '').toLowerCase();
        const span = document.createElement('span');
        span.className = 'statusIcon';
        if (s === 'closed') {
          span.textContent = '✓';
          span.title = 'closed';
          span.setAttribute('aria-label', 'closed');
        } else if (s === 'open') {
          span.textContent = '◯';
          span.title = 'open';
          span.setAttribute('aria-label', 'open');
        } else {
          span.textContent = '?';
          span.title = 'unknown';
          span.setAttribute('aria-label', 'unknown');
        }
        return span;
      }

      async function load() {
        try {
          const resp = await fetch(DATA_URL, { cache: 'no-store' });
          if (!resp.ok) throw new Error(`Failed to load ${DATA_URL}: ${resp.status}`);
          const data = await resp.json();

          text(document.getElementById('generatedAt'), `generated_at: ${data.generated_at || '—'}`);
          text(document.getElementById('totalFeatures'), data?.summary?.total_features ?? '—');

          const features = Array.isArray(data.features) ? data.features : [];
          const dates = features.map(f => yyyyMmDd(f.date_discovered)).filter(Boolean).sort();
          text(document.getElementById('firstDate'), dates[0] || '—');
          text(document.getElementById('lastDate'), dates[dates.length - 1] || '—');

          // Opened / closed counts (relative to generated_at)
          {
            const nowMs = msSinceEpoch(data.generated_at) ?? Date.now();
            const dayMs = 24 * 60 * 60 * 1000;
            const since7 = nowMs - 7 * dayMs;
            const since30 = nowMs - 30 * dayMs;

            const opened7 = countSinceMs(features, f => f.date_discovered, since7);
            const opened30 = countSinceMs(features, f => f.date_discovered, since30);
            const closed7 = countSinceMs(features, f => f.closed_at, since7);
            const closed30 = countSinceMs(features, f => f.closed_at, since30);

            text(document.getElementById('openedLast7'), opened7);
            text(document.getElementById('closedLast7'), closed7);
            text(document.getElementById('openedLast30'), opened30);
            text(document.getElementById('closedLast30'), closed30);
          }

          // Time series
          {
            const tbody = clearTbody(document.getElementById('timeSeriesTable'));
            const ts = data?.time_series?.time_series || [];
            for (const r of ts) row(tbody, [r.date, r.count, r.cumulative]);
          }

          // Product areas
          {
            const table = document.getElementById('productAreaTable');
            const thead = table.querySelector('thead');
            const tbody = clearTbody(table);

            while (thead.firstChild) thead.removeChild(thead.firstChild);

            const rows = data?.product_area_breakdown?.product_areas || [];
            const headerTr = document.createElement('tr');

            function normCategory(s) {
              return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
            }

            const preferredOrder = [
              'MS LEARN MODULE UPDATE REQUEST',
              'DEPRECATED/POTENTIALLY OUTDATED CONTENT',
              'SUGGESTED CONTENT UPDATES',
              'OTHER (SUPPORT/AMBIGUOUS/PROCESS)',
              'PLACEHOLDERS (TEMPLATE-INCOMPLETE)',
              'GRAMMAR/SPELLING',
            ].map(normCategory);

            const rowsByNorm = new Map();
            for (const r of rows) rowsByNorm.set(normCategory(r.name), r);

            const orderedRows = [];
            for (const k of preferredOrder) {
              const r = rowsByNorm.get(k);
              if (r) orderedRows.push(r);
            }
            for (const r of rows) {
              const k = normCategory(r.name);
              if (!preferredOrder.includes(k)) orderedRows.push(r);
            }

            const featuresByArea = new Map();
            for (const f of features) {
              const key = normCategory(f.product_area || '');
              if (!featuresByArea.has(key)) featuresByArea.set(key, []);
              featuresByArea.get(key).push(f);
            }

            const dataTr = document.createElement('tr');

            for (const r of orderedRows) {
              const areaName = String(r.name ?? '');
              const areaKey = normCategory(areaName);

              const th = document.createElement('th');
              th.textContent = areaName;
              headerTr.appendChild(th);

              const td = document.createElement('td');

              const countDiv = document.createElement('div');
              const strong = document.createElement('strong');
              strong.textContent = String(r.count ?? 0);
              countDiv.appendChild(strong);
              td.appendChild(countDiv);

              const areaFeatures = featuresByArea.get(areaKey) || [];
              areaFeatures.sort((a, b) => {
                const da = yyyyMmDd(a.date_discovered);
                const db = yyyyMmDd(b.date_discovered);
                if (da < db) return 1;
                if (da > db) return -1;
                return String(a.title || a.id).localeCompare(String(b.title || b.id));
              });

              if (areaFeatures.length) {
                td.appendChild(document.createElement('hr'));
                const linksDiv = document.createElement('div');
                for (const f of areaFeatures) {
                  const rowDiv = document.createElement('div');
                  rowDiv.className = 'issueRow';
                  rowDiv.appendChild(statusIcon(f.state));
                  rowDiv.appendChild(link(f.source_url, f.title || f.id));
                  linksDiv.appendChild(rowDiv);
                }
                td.appendChild(linksDiv);
              }

              dataTr.appendChild(td);
            }

            thead.appendChild(headerTr);
            tbody.appendChild(dataTr);
          }

          text(document.getElementById('rawJson'), JSON.stringify(data, null, 2));

        } catch (err) {
          const pre = document.getElementById('rawJson');
          pre.classList.add('error');
          pre.textContent = String(err);
        }
      }

      load();
    </script>
  </body>
</html>
