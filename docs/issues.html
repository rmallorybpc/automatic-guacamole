<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GitHub Partners / Microsoft Learn Issues Dashboard</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.35; }
      header { display: flex; align-items: baseline; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
      h1 { margin: 0; font-size: 22px; }
      .meta { color: #555; font-size: 12px; }
      .toplinks { margin-top: 6px; }
      .toolbar { display:flex; align-items:center; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
      .btn {
        border: 1px solid #d0d7de;
        background: #f6f8fa;
        color: #24292f;
        border-radius: 999px;
        padding: 7px 12px;
        font: inherit;
        cursor: pointer;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        user-select: none;
      }
      .btn:hover { background: #eef1f4; }
      .btn:active { background: #e7ebef; }
      .btn[disabled] { opacity: .55; cursor: not-allowed; }
      .btnIcon { width: 14px; height: 14px; display:inline-block; }
      .refreshMeta { display:flex; flex-direction:column; align-items:flex-end; gap:2px; min-width: 220px; }
      .refreshStatus { min-height: 16px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin: 12px 0 16px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
      .kpiCard { padding: 8px; }
      .kpi { font-size: 16px; font-weight: 650; margin-top: 4px; }
      h2 { margin: 22px 0 10px; font-size: 16px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; vertical-align: top; }
      th { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: .02em; }
      hr { border: 0; border-top: 1px solid #eee; margin: 6px 0; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
      .error { color: #b00020; }
      a { color: #0969da; text-decoration: none; }
      a:hover { text-decoration: underline; }
      details > summary { cursor: pointer; user-select: none; }
      .sectionHeader { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
      .legend { color: #555; font-size: 13px; white-space: nowrap; }
      .legendItem { display: inline-flex; align-items: baseline; gap: 6px; margin-left: 10px; }
      .issueRow { display: flex; align-items: baseline; gap: 8px; margin: 2px 0; }
      .statusIcon { width: 14px; flex: 0 0 14px; text-align: center; font-size: 12px; line-height: 1; }
      .issueRow a { font-size: 13px; }
      .issueMonth { font-size: 13px; }
      .select {
        border: 1px solid #d0d7de;
        background: #fff;
        color: #24292f;
        border-radius: 6px;
        padding: 6px 10px;
        font: inherit;
        max-width: min(720px, 100%);
      }
      .inProgressEmpty { color: #555; font-size: 13px; }
      .miniBtn {
        border: 1px solid #d0d7de;
        background: #f6f8fa;
        color: #24292f;
        border-radius: 999px;
        padding: 4px 10px;
        font: inherit;
        cursor: pointer;
        line-height: 1;
      }
      .miniBtn:hover { background: #eef1f4; }
      .miniBtn:active { background: #e7ebef; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>GitHub Partners / Microsoft Learn Issues Dashboard</h1>
      </div>
      <div>
        <div class="toolbar" aria-label="Dashboard refresh controls">
          <button id="refreshBtn" type="button" class="btn">
            <span class="btnIcon" aria-hidden="true">⟳</span>
            <span>Refresh dashboard</span>
          </button>
          <div class="refreshMeta">
            <div class="meta refreshStatus" id="refreshStatus"></div>
            <div class="meta" id="generatedAt"></div>
          </div>
        </div>
      </div>
    </header>

    <section class="grid">
      <div class="card kpiCard">
        <div class="meta">Total features</div>
        <div class="kpi" id="totalFeatures">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">First discovered</div>
        <div class="kpi" id="firstDate">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Last discovered</div>
        <div class="kpi" id="lastDate">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Opened (last 7 days)</div>
        <div class="kpi" id="openedLast7">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Closed (last 7 days)</div>
        <div class="kpi" id="closedLast7">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Opened (last 30 days)</div>
        <div class="kpi" id="openedLast30">—</div>
      </div>
      <div class="card kpiCard">
        <div class="meta">Closed (last 30 days)</div>
        <div class="kpi" id="closedLast30">—</div>
      </div>
    </section>

    <div class="sectionHeader">
      <h2>Product area breakdown</h2>
      <div class="legend" aria-label="Status legend">
        <span class="legendItem"><span class="statusIcon" aria-label="open">◯</span><span>open</span></span>
        <span class="legendItem"><span class="statusIcon" aria-label="closed">✓</span><span>closed</span></span>
        <span class="legendItem">Closed issues &gt;30 days hidden</span>
      </div>
    </div>
    <div class="card">
      <table id="productAreaTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="sectionHeader">
      <h2>In Progress</h2>
      <div class="legend" aria-label="In Progress controls">
        <span class="meta">Loads: <code>reports/in_progress.json</code></span>
        <span class="legendItem">
          <label class="meta" for="inProgressSelect">Add open item:</label>
          <select id="inProgressSelect" class="select"></select>
        </span>
        <span class="legendItem">
          <a id="downloadInProgressBtn" class="btn" href="#" download="in_progress.json">Download in_progress.json</a>
        </span>
      </div>
    </div>
    <div class="card">
      <div id="inProgressList" class="inProgressEmpty">Loading…</div>
    </div>

    <h2>Monthly Issue Report</h2>
    <div class="card">
      <table id="monthlyReportTable">
        <thead><tr><th>Month</th><th>Links</th></tr></thead>
        <tbody>
          <tr><td colspan="2" class="meta">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <h2>Time series</h2>
    <details class="card" id="timeSeriesDetails">
      <summary class="meta">Expand / collapse</summary>
      <table id="timeSeriesTable">
        <thead><tr><th>Date</th><th>Count</th><th>Cumulative</th></tr></thead>
        <tbody></tbody>
      </table>
    </details>

    <h2>Raw JSON</h2>
    <div class="meta">Loads: <code>reports/dashboard_all_issues.json</code></div>
    <details class="card" id="rawJsonDetails">
      <summary class="meta">Expand / collapse</summary>
      <pre id="rawJson">Loading…</pre>
    </details>

    <script>
      const DATA_URL = 'reports/dashboard_all_issues.json';
      const IN_PROGRESS_URL = 'reports/in_progress.json';

      let DASHBOARD_DATA = null;
      let DASHBOARD_FEATURES = [];

      function text(el, value) { el.textContent = value; }
      function yyyyMmDd(iso) { return iso ? String(iso).slice(0, 10) : ''; }

      function featureState(f) {
        return String(f?.state || '').toLowerCase();
      }

      async function loadInProgressIds() {
        try {
          const resp = await fetch(IN_PROGRESS_URL, { cache: 'no-store' });
          if (!resp.ok) return new Set();
          const data = await resp.json();
          const ids = Array.isArray(data?.in_progress_ids) ? data.in_progress_ids
            : Array.isArray(data) ? data
            : [];
          return new Set(ids.map(String));
        } catch {
          return new Set();
        }
      }

      function serializeInProgressJson(inProgressSet) {
        return JSON.stringify({
          schema: 1,
          updated_at: new Date().toISOString(),
          in_progress_ids: Array.from(inProgressSet).sort(),
        }, null, 2);
      }

      function updateDownloadLink(inProgressSet) {
        const a = document.getElementById('downloadInProgressBtn');
        if (!a) return;
        const json = serializeInProgressJson(inProgressSet);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        a.href = url;
      }

      function renderInProgressSection(features, inProgressSet) {
        const listEl = document.getElementById('inProgressList');
        const selectEl = document.getElementById('inProgressSelect');

        if (selectEl) {
          while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);

          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Select an open issue…';
          placeholder.selected = true;
          selectEl.appendChild(placeholder);

          const candidates = (Array.isArray(features) ? features : [])
            .filter(f => featureState(f) === 'open')
            .filter(f => !inProgressSet.has(String(f?.id || '')))
            .sort((a, b) => String(a.title || a.id).localeCompare(String(b.title || b.id)));

          for (const f of candidates) {
            const opt = document.createElement('option');
            opt.value = String(f.id);
            opt.textContent = String(f.title || f.id);
            selectEl.appendChild(opt);
          }

          selectEl.onchange = () => {
            const id = String(selectEl.value || '');
            if (!id) return;
            inProgressSet.add(id);
            renderInProgressSection(features, inProgressSet);
            renderProductAreas(DASHBOARD_DATA, DASHBOARD_FEATURES, inProgressSet);
            updateDownloadLink(inProgressSet);
            selectEl.value = '';
          };
        }

        if (!listEl) return;
        while (listEl.firstChild) listEl.removeChild(listEl.firstChild);

        const inProgress = (Array.isArray(features) ? features : [])
          .filter(f => featureState(f) === 'open')
          .filter(f => inProgressSet.has(String(f?.id || '')))
          .sort((a, b) => {
            const da = yyyyMmDd(a.date_discovered);
            const db = yyyyMmDd(b.date_discovered);
            if (da < db) return 1;
            if (da > db) return -1;
            return String(a.title || a.id).localeCompare(String(b.title || b.id));
          });

        if (!inProgress.length) {
          listEl.textContent = 'No issues marked In Progress.';
          return;
        }

        const frag = document.createDocumentFragment();
        for (const f of inProgress) {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'issueRow';
          rowDiv.appendChild(statusIcon(f.state));
          rowDiv.appendChild(link(f.source_url, f.title || f.id));

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'miniBtn';
          removeBtn.textContent = 'Remove';
          removeBtn.setAttribute('aria-label', `Remove from In Progress: ${String(f.title || f.id)}`);
          removeBtn.addEventListener('click', () => {
            inProgressSet.delete(String(f.id));
            renderInProgressSection(features, inProgressSet);
            renderProductAreas(DASHBOARD_DATA, DASHBOARD_FEATURES, inProgressSet);
            updateDownloadLink(inProgressSet);
          });
          rowDiv.appendChild(removeBtn);

          frag.appendChild(rowDiv);
        }
        listEl.appendChild(frag);
      }

      function renderProductAreas(data, features, inProgressSet) {
        const table = document.getElementById('productAreaTable');
        if (!table) return;

        const thead = table.querySelector('thead');
        const tbody = clearTbody(table);

        while (thead.firstChild) thead.removeChild(thead.firstChild);

        const rows = data?.product_area_breakdown?.product_areas || [];
        const headerTr = document.createElement('tr');

        function normCategory(s) {
          return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
        }

        const preferredOrder = [
          'MS LEARN MODULE UPDATE REQUEST',
          'DEPRECATED/POTENTIALLY OUTDATED CONTENT',
          'SUGGESTED CONTENT UPDATES',
          'OTHER (SUPPORT/AMBIGUOUS/PROCESS)',
          'PLACEHOLDERS (TEMPLATE-INCOMPLETE)',
          'GRAMMAR/SPELLING',
        ].map(normCategory);

        const rowsByNorm = new Map();
        for (const r of rows) rowsByNorm.set(normCategory(r.name), r);

        const orderedRows = [];
        for (const k of preferredOrder) {
          const r = rowsByNorm.get(k);
          if (r) orderedRows.push(r);
        }
        for (const r of rows) {
          const k = normCategory(r.name);
          if (!preferredOrder.includes(k)) orderedRows.push(r);
        }

        const featuresByArea = new Map();
        for (const f of (Array.isArray(features) ? features : [])) {
          if (isMonthlyIssueReportFeature(f)) continue;
          const key = normCategory(f.product_area || '');
          if (!featuresByArea.has(key)) featuresByArea.set(key, []);
          featuresByArea.get(key).push(f);
        }

        const dataTr = document.createElement('tr');

        for (const r of orderedRows) {
          const areaName = String(r.name ?? '');
          const areaKey = normCategory(areaName);

          const th = document.createElement('th');
          th.textContent = areaName;
          headerTr.appendChild(th);

          const td = document.createElement('td');

          const countDiv = document.createElement('div');
          const strong = document.createElement('strong');
          strong.textContent = String(r.count ?? 0);
          countDiv.appendChild(strong);
          td.appendChild(countDiv);

          const areaFeaturesRaw = featuresByArea.get(areaKey) || [];
          const areaFeatures = areaFeaturesRaw
            .filter(f => {
              // Open issues can be moved to In Progress (and then removed from this section).
              if (featureState(f) === 'open' && inProgressSet?.has(String(f?.id || ''))) return false;
              return true;
            });

          areaFeatures.sort((a, b) => {
            const da = yyyyMmDd(a.date_discovered);
            const db = yyyyMmDd(b.date_discovered);
            if (da < db) return 1;
            if (da > db) return -1;
            return String(a.title || a.id).localeCompare(String(b.title || b.id));
          });

          if (areaFeatures.length) {
            td.appendChild(document.createElement('hr'));
            const linksDiv = document.createElement('div');
            for (const f of areaFeatures) {
              const rowDiv = document.createElement('div');
              rowDiv.className = 'issueRow';
              rowDiv.appendChild(statusIcon(f.state));
              rowDiv.appendChild(link(f.source_url, f.title || f.id));
              linksDiv.appendChild(rowDiv);
            }
            td.appendChild(linksDiv);
          }

          dataTr.appendChild(td);
        }

        thead.appendChild(headerTr);
        tbody.appendChild(dataTr);
      }

      function msSinceEpoch(iso) {
        if (!iso) return null;
        const d = new Date(String(iso));
        const t = d.getTime();
        return Number.isFinite(t) ? t : null;
      }

      function countSinceMs(items, getIso, thresholdMs) {
        let n = 0;
        for (const it of items) {
          const t = msSinceEpoch(getIso(it));
          if (t != null && t >= thresholdMs) n += 1;
        }
        return n;
      }

      function clearTbody(table) {
        const tbody = table.querySelector('tbody');
        while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
        return tbody;
      }

      function row(tbody, cells) {
        const tr = document.createElement('tr');
        for (const c of cells) {
          const td = document.createElement('td');
          if (c instanceof Node) td.appendChild(c);
          else td.textContent = String(c);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function link(href, label) {
        const a = document.createElement('a');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = label;
        return a;
      }

      function statusIcon(state) {
        const s = String(state || '').toLowerCase();
        const span = document.createElement('span');
        span.className = 'statusIcon';
        if (s === 'closed') {
          span.textContent = '✓';
          span.title = 'closed';
          span.setAttribute('aria-label', 'closed');
        } else if (s === 'open') {
          span.textContent = '◯';
          span.title = 'open';
          span.setAttribute('aria-label', 'open');
        } else {
          span.textContent = '?';
          span.title = 'unknown';
          span.setAttribute('aria-label', 'unknown');
        }
        return span;
      }

      function fmtLocal(iso) {
        if (!iso) return '—';
        const d = new Date(String(iso));
        const t = d.getTime();
        if (!Number.isFinite(t)) return String(iso);
        // Example: 2025-12-19 10:22:11
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mi = String(d.getMinutes()).padStart(2, '0');
        const ss = String(d.getSeconds()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }

      function fmtRelativeFromNow(iso) {
        const t = msSinceEpoch(iso);
        if (t == null) return null;
        const deltaMs = Date.now() - t;
        if (!Number.isFinite(deltaMs)) return null;
        if (deltaMs < 0) return 'in the future';
        const sec = Math.floor(deltaMs / 1000);
        if (sec < 10) return 'just now';
        if (sec < 60) return `${sec}s ago`;
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min}m ago`;
        const hr = Math.floor(min / 60);
        if (hr < 48) return `${hr}h ago`;
        const day = Math.floor(hr / 24);
        return `${day}d ago`;
      }

      function yyyyMm(iso) {
        if (!iso) return '—';
        const s = String(iso);
        // generated_at is ISO; YYYY-MM is sufficient for month labeling.
        return s.length >= 7 ? s.slice(0, 7) : s;
      }

      function isMonthlyIssueReportFeature(f) {
        const t = String(f?.title || '');
        return t.includes('Monthly Issue Report');
      }

      function renderMonthlyReport(data, features) {
        const table = document.getElementById('monthlyReportTable');
        if (!table) return;

        const tbody = clearTbody(table);

        const monthlyFeatures = (Array.isArray(features) ? features : []).filter(isMonthlyIssueReportFeature);
        if (!monthlyFeatures.length) {
          row(tbody, ['—', 'No Monthly Issue Report issues found']);
          return;
        }

        monthlyFeatures.sort((a, b) => {
          const da = yyyyMmDd(a.date_discovered);
          const db = yyyyMmDd(b.date_discovered);
          if (da < db) return 1;
          if (da > db) return -1;
          return String(a.title || a.id).localeCompare(String(b.title || b.id));
        });

        for (const f of monthlyFeatures) {
          const m = yyyyMm(f.date_discovered || data?.generated_at);

          const monthSpan = document.createElement('span');
          monthSpan.className = 'issueMonth';
          monthSpan.textContent = m;

          const rowDiv = document.createElement('div');
          rowDiv.className = 'issueRow';
          rowDiv.appendChild(statusIcon(f.state));
          rowDiv.appendChild(link(f.source_url, f.title || f.id));

          row(tbody, [monthSpan, rowDiv]);
        }
      }

      async function load() {
        try {
          const [data, inProgressSet] = await Promise.all([
            (async () => {
              const resp = await fetch(DATA_URL, { cache: 'no-store' });
              if (!resp.ok) throw new Error(`Failed to load ${DATA_URL}: ${resp.status}`);
              return await resp.json();
            })(),
            loadInProgressIds(),
          ]);

          {
            const iso = data.generated_at || null;
            const rel = fmtRelativeFromNow(iso);
            const abs = fmtLocal(iso);
            text(document.getElementById('generatedAt'), rel ? `Last updated ${rel} • ${abs}` : `Last updated • ${abs}`);
          }
          text(document.getElementById('totalFeatures'), data?.summary?.total_features ?? '—');

          const features = Array.isArray(data.features) ? data.features : [];
          const dates = features.map(f => yyyyMmDd(f.date_discovered)).filter(Boolean).sort();
          text(document.getElementById('firstDate'), dates[0] || '—');
          text(document.getElementById('lastDate'), dates[dates.length - 1] || '—');

          // Opened / closed counts (relative to generated_at)
          {
            const nowMs = msSinceEpoch(data.generated_at) ?? Date.now();
            const dayMs = 24 * 60 * 60 * 1000;
            const since7 = nowMs - 7 * dayMs;
            const since30 = nowMs - 30 * dayMs;

            const opened7 = countSinceMs(features, f => f.date_discovered, since7);
            const opened30 = countSinceMs(features, f => f.date_discovered, since30);
            const closed7 = countSinceMs(features, f => f.closed_at, since7);
            const closed30 = countSinceMs(features, f => f.closed_at, since30);

            text(document.getElementById('openedLast7'), opened7);
            text(document.getElementById('closedLast7'), closed7);
            text(document.getElementById('openedLast30'), opened30);
            text(document.getElementById('closedLast30'), closed30);
          }

          // Time series
          {
            const tbody = clearTbody(document.getElementById('timeSeriesTable'));
            const ts = data?.time_series?.time_series || [];
            for (const r of ts) row(tbody, [r.date, r.count, r.cumulative]);
          }

          // Monthly report links
          renderMonthlyReport(data, features);

          DASHBOARD_DATA = data;
          DASHBOARD_FEATURES = features;

          // Never show closed issues as In Progress (but keep their IDs in the file).
          renderInProgressSection(features, inProgressSet);
          updateDownloadLink(inProgressSet);

          // Product areas
          renderProductAreas(data, features, inProgressSet);

          text(document.getElementById('rawJson'), JSON.stringify(data, null, 2));

        } catch (err) {
          const pre = document.getElementById('rawJson');
          pre.classList.add('error');
          pre.textContent = String(err);

          const table = document.getElementById('monthlyReportTable');
          if (table) {
            const tbody = clearTbody(table);
            row(tbody, ['—', String(err)]);
          }
        }
      }

      async function refreshDashboard() {
        const btn = document.getElementById('refreshBtn');
        const status = document.getElementById('refreshStatus');
        const setStatus = (s) => { if (status) text(status, s); };

        if (btn) btn.disabled = true;
        setStatus('Refreshing…');

        // If served via `scripts/dev_dashboard_server.py`, we can refresh in-place.
        try {
          const resp = await fetch('/__refresh_both', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          if (!resp.ok) throw new Error(`refresh failed: ${resp.status}`);
          const payload = await resp.json();
          if (!payload?.ok) throw new Error('refresh failed');
          setStatus('Refresh complete');
          // Reload JSON to update the timestamp/KPIs.
          await load();
          return;
        } catch (e) {
          // Fall back to opening GitHub Actions when running from static hosting.
        } finally {
          if (btn) btn.disabled = false;
        }

        const repo = 'rmallorybpc/automatic-guacamole';
        const workflowFile = 'refresh-dashboard.yml';
        const url = `https://github.com/${repo}/actions/workflows/${workflowFile}?query=branch%3Amain`;
        window.open(url, '_blank', 'noopener,noreferrer');
        setStatus('Opened GitHub Actions — click “Run workflow”');
      }

      document.getElementById('refreshBtn')?.addEventListener('click', refreshDashboard);
      load();
    </script>
  </body>
</html>
